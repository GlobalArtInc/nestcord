---
id: лавянный
title: Лавовый
sidebar_position: 3
---

Transform your bot into a professional DJ with the power of the [Lavalink](https://lavalink.dev/) ecosystem. Этот пакет использует [lavalink-client](https://github.com/Tomato6966/lavalink-client) за сцены, обеспечивая высокопроизводительное и эффективное решение для управления аудио потоками в Discord. Используя Lavalink, ваш бот получает возможность управлять воспроизведением, очередями, и управление в реальном времени с минимальными задержками, превращая его в полноценную и профессиональную музыкальную систему.

## Установка

```bash npm2yarn
npm i lavalink-client
```

- [Руководство по установке Lavalink](https://lavalink.dev/getting-started/index.html)

## Использование

После завершения установки мы можем импортировать `NestCordLavalinkModule` с вашим `NestCordModule` в корень `AppModule`:

```typescript title="app.module.ts"
import { NestCordLavalinkModule } from '@globalart/nestcord';
import { Module } from '@nestjs/common';
import { Client } from 'discord. s';
импорт { AppService } из './app. ervice';

@Module({
    imports: [
        NestCordModule. orRoot({
            token: process.env. Ставка по ISCORD,
            intents: [
                IntentsBitField. lags.Guilds,
                IntentsBitField.Flags. uildVoiceStates
            ],
        }),
        NestCordLavalinkModule. orRoot({
            // Требуется хотя бы 1 узел
            узлов: [
                {
                    authorization: 'youshallnotpass',
                    хост: '127. .0.1',
                    порта: 2333,
                }
            ]
        })
    ],
    провайдеров: [AppService]
})
экспорт класса AppModule {}
```

Посмотрите больше модулей в официальной [**lavalink-client** Документации](https://lc4.gitbook.io/lavalink-client/docs/lavalinkmanager/manager-options).

## Слушатели

```typescript title="app.service.ts"
import { Injectable, Logger } from '@nestjs/common';
import { Context, OnLavalinkManager, OnNodeManager, LavalinkManagerContextOf, NodeManagerContextOf } from '@globalart/nestcord';

@Injectable()
export class AppService {
    private readonly logger = new Logger(AppService.

    @OnNodeManager('connect')
    public onConnect(@Context() [node]: NodeManagerContextOf<'connect'>) {
        это. оггер. og(`Node: ${node.options.id} Подключено`);
    }

    @OnLavalinkManager('playerCreate')
    public onPlayerCreate(@Context() [player]: LavalinkManagerContextOf<'playerCreate'>) {
        this. ogger.log(`Игрок, созданный на ${player.guildId}`);
    }
}
```

### События LavalinkManager

- Посмотреть в официальной [**lavalink-client** документации](https://tomato6966.github.io/lavalink-client/extra/manager-events/).

| Название события                | Описание                                                                                                                               |
| ------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------- |
| «trackStart»                    | Возникает всякий раз, когда играет трек.                                                                                               |
| `trackEnd`                      | Возникает всякий раз, когда трек закончил воспроизведение.                                                                             |
| «trackStuck»                    | Возникает всякий раз, когда трек застрял во время игры.                                                                                |
| `trackError`                    | Возникает всякий раз, когда трек удаляется.                                                                                            |
| `очередь`                       | Возникает, когда трек закончился, но в очереди больше нет треков. (`trackEnd`, НЕ выполняется)                                         |
| `playerCreate`                  | Возникает при создании игрока.                                                                                                         |
| `playerMove`                    | Возникает всякий раз, когда игрок перемещается между голосовыми каналами.                                                              |
| `playerDisconnect`              | Возникает всякий раз, когда игрок отключен от канала.                                                                                  |
| `playerSocketClose`             | Возникает всякий раз, когда Node-Socket был закрыт для определенного игрока.                                                           |
| `игрокаDestroy`                 | Происходит всякий раз, когда игрок уничтожается.                                                                                       |
| «обновить»                      | Происходит всякий раз, когда игрок получает обновление от Lavalink'а события.                                                          |
| `playerMuteChange`              | Возникает всякий раз, когда состояние голоса Игрока связано с заглушением.                                                             |
| `playerDeafChange`              | Возникает всякий раз, когда состояние голоса Игрока связано с глушителями.                                                             |
| `игрокаВскрытие`                | Возникает всякий раз, когда состояние голоса Игрока связано с сюжетным изменением.                                                     |
| `playerQueueEmptyStart`         | Возникает при запуске пустого обработчика очереди (таймаут).                                                                           |
| «Очередь игрока пуста»          | Происходит когда пустой обработчик очереди завершился (успешно) и уничтожил игрока.                                                    |
| «Очередь игроков пуста Отмена»  | Возникает всякий раз, когда пустой обработчик отменил (например, потому, что был добавлен новый трек).                                 |
| `playerVoiceJoin`               | Возникает когда пользователь присоединяется к голосовому каналу игрока.                                                                |
| «VoiceLeave»                    | Возникает каждый раз, когда пользователь покидает голосовой канал игрока.                                                              |
| `debug`                         | Возникает для нескольких erros и журналов в lavalink-клиенте, если `managerOptions.advancedOptions.enableDebugEvents` является `true`. |

#### События плагина SponsorBlock

- Эти события являются частью [событий LavalinkManager](#lavalinkmanager-events).
- Это требует добавления [**SponsorBlock**](https://github.com/topi314/Sponsorblock-Plugin) на сервер Lavalink .

| Название события                | Описание                                                               |
| ------------------------------- | ---------------------------------------------------------------------- |
| `SegmentsLoaded`                | Возникает всякий раз, когда сегменты загружаются.                      |
| `SegmentSkipped`                | Возникает всякий раз, когда пропущен определённый сегмент.             |
| «Начатая глава»                 | Происходит всякий раз, когда начинает играть конкретная глава          |
| «Загруженные главы»             | Возникает всякий раз, когда загружаются главы.                         |

#### Плагин LavaLyrics

- Эти события являются частью [событий LavalinkManager](#lavalinkmanager-events).
- Это требует добавления [**LavaLyrics Plugin**](https://github.com/topi314/LavaLyrics) на Lavalink Server.

| Название события                | Описание                                                               |
| ------------------------------- | ---------------------------------------------------------------------- |
| `LyricsLine`                    | Возникает всякий раз, когда получается строка текста.                  |
| `LyricsFound`                   | Возникает всякий раз, когда найден текст песни.                        |
| `LyricsNotFound`                | Возникает всякий раз, когда текст песни не найден.                     |

### События диспетчера узлов

- Посмотреть в официальной [**lavalink-client** документации](https://tomato6966.github.io/lavalink-client/extra/node-events/).

| Название события                | Описание                                                                                                                                                                                                                                                                     |
| ------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `создать`                       | Возникает каждый раз, когда создается узел.                                                                                                                                                                                                                                  |
| `уничтожить`                    | Возникает всякий раз, когда узел уничтожается.                                                                                                                                                                                                                               |
| `connect`                       | Возникает всякий раз, когда узел подключен.                                                                                                                                                                                                                                  |
| `переподключение`               | Возникает каждый раз, когда узел переподключается.                                                                                                                                                                                                                           |
| `переподключение`               | Возникает каждый раз, когда узел начинает переподключаться. (если у вас есть задержка переподключения, то событие повторного подключения будет выведено после задержек повторного подключения.) Полезно для проверки работы внутренней системы переподключения узла или нет. |
| `disconnect`                    | Возникает всякий раз, когда узел разъединяется.                                                                                                                                                                                                                              |
| `ошибка`                        | Возникает всякий раз, когда ошибка узла.                                                                                                                                                                                                                                     |
| `raw`                           | Выполняет каждое событие узла.                                                                                                                                                                                                                                               |

## Поставщики

```typescript title="app.service.ts"
import { Injectable } from '@nestjs/common';
import { LavalinkManager, NodeManager } from 'lavalink-client';

@Injectable()
export class AppService {
    public constructor(
        private readonly lavalinkManager: LavalinkManager,
        частный читаемый nodeManager: NodeManager,
    ) {}
}
```

| Класс (Тип для впрыскивания)   | Свойство менеджера (будет доступ)    | Описание                 |
| ------------------------------ | ------------------------------------ | ------------------------ |
| `LavalinkManager`              | `lavalinkManager`                    | Менеджер Lavalink        |
| `Менеджер узлов`               | `lavalinkManager.nodeManager`        | Менеджер узлов           |
| `Менеджер игроков`             | `lavalinkManager (функции игрока)`   | Менеджер плеера          |

## Играть треки

```typescript title="app.commands.ts"
импорт { Injectable, UseInterceptors } из '@nestjs/common';
импорт { NestCordLavalinkService, PlayerManager } из 'lavalink-client';
импортировать { Context, Options, SlashCommand, SlashCommandContext } из '@globalart/nestcord';
импортировать { QueryDto } из '. query.dto;
импортировать { SourceAutocompleteInterceptor } из источника. завершение;

@Injectable()
export class AppCommands {
    public constructor(
        private readonly playerManager: PlayerManager,
        частных чтенных lavalinkService: NestCordLavalinkService
    ) {}

    @UseInterceptors(SourceAutocompleteInterceptor)
    @SlashCommand({
        name: 'play',
        description: 'play a track',
    })
    public async onPlay(
        @Context() [interaction]: SlashCommandContext,
        @Options() { query, source }: QueryDto,
    ) {
        const player =
            this. layerManager.get(interaction.guild.id) ??
            this.playerManager. reate({
                ...this.lavalinkService. xtractInfoForPlayer(взаимодействие),
                // необязательные конфигурации:
                selfDeaf: true,
                selfMute: false,
                объем 100,
            });

        ждет игрока. onnect();

        const res = ожидать игрока. earch(
            {
                запрос,
                источник: исходник ? 'soundcloud'
            },
            взаимодействие. ser.id,
        );

        ожидает player.queue.add(с. стойки[0]);
        если (!player.playing) ждут игрока. lay();

        // Очень рекомендуется использовать событие `trackStart` для обратного взаимодействия объявления
        . eply({
            content: `Now playing ${res.tracks[0]. nfo.title}`,
        });
    }
}
```

```typescript title="query.dto.ts"
import { SearchPlatform } from 'lavalink-client';
import { StringOption } from '@globalart/nestcord';

export class QueryDto {
    @StringOption({
        name: 'query',
        описание: '<name | url> запрошенного трека'
        требуется: true
    })
    доступный запрос! строка;

    @StringOption({
        name: 'source',
        описание: "источник трека",
        автозаполнение: true,
        обязательно: false,
    })
    публичный источник только для чтения? SourcePlatform;
}
```

```typescript title="source.autocomplete.ts"
import { Injectable } from '@nestjs/common';
import { AutocompleteInteraction } from 'discord. s';
импортировать { DefaultSources } из 'lavalink-client';
импортировать { AutocompleteInterceptor } из '@globalart/nestcord';

@Injectable()
export class SourceAutocompleteInterceptor extends AutocompleteInterceptor {
    public transformOptions(interaction: AutocompleteInteraction) {
        const focused = interaction. ptions.getFocused(true);
        let choices: string[];

        if (focused. ame === 'source') {
            выбора = [DefaultSources.soundcloud] // Заметьте, что некоторым источникам нужны дополнительные плагины/настройки для свойств work
        }

        return interaction. espond(
        выбор
            . ilter(выбор) => choice.startsWith(focused.value. oString()))
            . ap((выбор) => ({ name: choice, value: choice })),
        );
    }
}
```
