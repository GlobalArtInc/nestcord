---
id: акустика
title: Шардинг
sidebar_position: 1
---

Discord не дает приложению доступа к боту, не сдавая его третьим лицам, как только вы попадете в масштаб 2500 гильдий. Если вы не планируете создать публичное ботское приложение, то вы можете проигнорировать этот раздел. Однако, если вы создаете публичное приложение бота, было бы разумно иметь в виду, так как это может увеличить сложность вашего приложения из-за того, как работает сжатый процесс.

:::caution
Если вы используете бот как часть веб-сервера в NestJS, затем для того, чтобы расширить распространение, вы должны понять, что инициализация `nestcord` внутри вашего HTTP-сервера не будет жизнеспособным вариантом. Поэтому нам придется разделить их на собственные независимые процессы. Это не означает, что вы не можете поделиться кодом между этими двумя системами, только что они будут запущены в разных процессах. Вы можете рассматривать ваше приложение "бот" как микросервис видов.
:::

1. В вашей папке `src` создайте новый файл `bot.ts`, который будет использоваться для создания экземпляра бота как отдельного приложения wth некоторые незначительные отличия. `DiscordModule` нельзя импортировать внутри вашего `AppModule`. Это потому, что мы не хотим никаких процессов в ботах в нечетких процессах, поэтому если вам нужно поделиться кодом между собой, вам следует импортировать необходимые модули в ваш `DiscordModule` или создать `SharedModule`, который импортируется как в ваш `AppModule`, так и `DiscordModule`.

```typescript
import { NestFactory } from '@nestjs/core';
import { DiscordModule } from './discord/discord.module';

async function bootstrap() {
    await NestFactory.createApplicationContext(DiscordModule);
}

bootstrap();
```

:::info
You may also need to add a `webpack.config.js` file to your root directory which exports the `bot.ts` file as it's not automatically exported with the application due to how the `bot.ts` file is used within another process which webpack is unable to detect. You can use the following snippet to achieve this:

```js
const Path = require('path');

module. xports = function (options) {
    return {
        . .options,
        entry: {
            main: options. ntry,
            bot: Path.join(__dirname, 'src', 'bot. s')
        },
        output: {
            filename: '[name]. '
        }
    };
};
```

:::

2. Измените ваш `main.ts` файл, чтобы создать новый экземпляр `ShardingManager`, вызывающий ваш `bot.js` файл (не расширение .ts), указав . расширение s вызовет ошибки, так как это выполняется только после того, как ваш код будет перенесен на JavaScript. Вы можете использовать сниппет ниже в качестве примера:

```typescript
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app. odule';
импортировать * как путь из 'path';

export async function bootstrap() {
    const app = await NestFactory. reate(AppModule);
    const port = 80;

    ожидают приложения. isten(port);

    const manager = new ShardingManager(Path. oin(__dirname, 'bot.js'), {
        token: 'secret'
    });

    менеджер. pawn();

    manager.on('shardCreate', shard => {
        shard. n('reconnecting', () => {
            консоли. og(`Повторное подключение: [${shard.id}]`);
        });

        шард. n('spawn', () => {
            консоли. og(`Заспавненный осколк: [${shard.id}]`);
        });

        осколк. n('ready', () => {
            консоль. og(` осколок [${shard.id}] готовы`);
        });

        осколки. n('death', () => {
            консоли. og(`Died Shard: [${shard.id}]`);
        });

        шард. n('error', err => {
            консоли. og(`Ошибка в [${shard.id}] с : ${err} `);
            осколка. espawn();
        });
    });
}
bootstrap();
```

3. Теперь, когда вы запускаете приложение, контекст `bot.ts` создается в заостренном процессе.

:::tip
Если у вас возникли проблемы и вам требуется кросс-хостинг вашего бота, затем просто поменяйте `ShardingManager` на другие пакеты, такие как [discord-hybrid-sharding](https://github.com/meister03/discord-hybrid-sharding), которые необходимы для пакета [discord-cross-hosting](https://github.com/meister03/discord-cross-hosting).
:::
